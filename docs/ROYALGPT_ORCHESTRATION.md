# RoyalGPT Orchestration Implementation Guide

This document describes the implementation of FASE 1-3 for API routing fixes and RoyalGPT orchestration capabilities.

## Overview

The RoyalGPT orchestration system provides:
- **100+ agent management** with dynamic registration
- **Token-based authentication** for protected endpoints
- **Background orchestration** for continuous agent execution
- **Health monitoring** with heartbeat verification
- **JSON API responses** (no HTML fallbacks)

## FASE 1: API Routing Fixes

### Problem
All API calls (like `/api/v2/products`, `/healthz`, `/agents/status`) were returning HTML instead of JSON, causing frontend fallback issues.

### Solution

#### 1. Fixed Flask 404 Handler
**File:** `app/routes/errors.py`

The 404 error handler now prioritizes JSON responses for:
- All `/api/*` routes
- Health endpoints: `/healthz`, `/readyz`, `/health/*`, `/liveness`, `/readiness`

```python
# Always return JSON for API routes and health endpoints
if request.path.startswith("/api/") or request.path.startswith("/health") or \
   request.path in ["/healthz", "/readyz", "/liveness", "/readiness"]:
    return jsonify({"error": "Not Found", ...}), 404
```

#### 2. Vite Proxy Configuration
**File:** `apps/command-center-ui/vite.config.ts`

Vite dev server properly proxies all API and health endpoints to Flask backend (port 10000):

```typescript
proxy: {
  '/api': { target: 'http://localhost:10000', changeOrigin: true },
  '/healthz': { target: 'http://localhost:10000', changeOrigin: true },
  '/readyz': { target: 'http://localhost:10000', changeOrigin: true },
  // ... other health endpoints
}
```

### Verification

Test API 404 handling:
```bash
curl http://localhost:10000/api/nonexistent
# Returns: {"error": "Not Found", "path": "/api/nonexistent", ...}
```

Test health endpoints:
```bash
curl http://localhost:10000/healthz
# Returns: {"status": "healthy"}

curl http://localhost:10000/readyz
# Returns: {"ready": true, "checks": [...], ...}
```

## FASE 2: RoyalGPT Orchestration & Authentication

### Configuration

Add to `.env` or environment variables:

```bash
# Enable RoyalGPT orchestration
ENABLE_ROYALGPT_ORCHESTRATION=true

# API key for authentication (set a secure token in production)
API_KEY_ROYALGPT=your-secure-token-here

# Agent authorization scope (* = all agents)
AUTHORIZED_AGENTS_SCOPE=*

# Background orchestrator settings
ORCHESTRATOR_INTERVAL_SECONDS=10
ORCHESTRATOR_MAX_CONCURRENT=10
```

### Token-Based Authentication

**File:** `core/security/auth.py`

Two new functions for RoyalGPT authentication:

#### 1. `is_royalgpt_authorized(request)`
Validates the Authorization header against configured API key.

```python
from core.security.auth import is_royalgpt_authorized

if not is_royalgpt_authorized():
    return jsonify({"error": "Unauthorized"}), 401
```

#### 2. `require_royalgpt_auth` decorator
Protects endpoints with authentication check:

```python
from core.security.auth import require_royalgpt_auth

@app.route('/api/sensitive/endpoint')
@require_royalgpt_auth
def protected_endpoint():
    return jsonify({"data": "secret"})
```

### Authentication Methods

The system supports two authentication formats:

1. **Bearer token:**
```bash
curl -H "Authorization: Bearer your-api-key" \
     http://localhost:10000/api/agents/agent_id/execute
```

2. **Plain token:**
```bash
curl -H "Authorization: your-api-key" \
     http://localhost:10000/api/agents/agent_id/execute
```

### 100+ Agent Support

**File:** `orchestrator/core/agent_registry.py`

New function `register_autogen_agents()` dynamically generates agents:

```python
from orchestrator.core.agent_registry import get_agent_registry, register_autogen_agents

registry = get_agent_registry()

# Register 100 autogenerated agents
result = await register_autogen_agents(registry, count=100)

print(f"Registered {result['registered']} agents")
```

Autogenerated agents have:
- Unique IDs: `autogen_agent_000` to `autogen_agent_099`
- AI orchestration capability
- Tags: `autogenerated`, `royalgpt`, `orchestration`
- Configurable concurrent task limits

### Background Orchestrator Agent

**File:** `orchestrator/agents/orchestrator_agent.py`

The `RoyalOrchestratorAgent` provides continuous background execution:

```python
from orchestrator.agents.orchestrator_agent import RoyalOrchestratorAgent

# Create and start orchestrator
orchestrator = RoyalOrchestratorAgent()
await orchestrator.run()  # Runs continuously
```

**Features:**
- Monitors all registered agents
- Executes ready agents based on schedules and priorities
- Respects concurrency limits
- Logs execution results
- Supports emergency stop

**Health Status:**
```python
health = orchestrator.get_health_status()
# Returns: {
#   "agent_name": "royal_orchestrator_agent",
#   "status": "active",
#   "statistics": {...},
#   "configuration": {...}
# }
```

### Protected Endpoints

Example of protected agent execution endpoint:

**File:** `app/routes/royalgpt_api.py`

```python
@royalgpt_bp.route("/agents/<agent_id>/execute", methods=["POST"])
def execute_agent(agent_id: str):
    """Trigger agent execution - requires authentication."""
    from core.security.auth import is_royalgpt_authorized
    
    if not is_royalgpt_authorized():
        return jsonify({"error": "Unauthorized"}), 401
    
    # Execute agent...
```

Usage:
```bash
# Without auth - fails
curl -X POST http://localhost:10000/api/agents/product_research/execute
# Returns: 401 Unauthorized

# With valid auth - succeeds
curl -X POST \
     -H "Authorization: Bearer your-api-key" \
     http://localhost:10000/api/agents/product_research/execute
# Returns: 200 with execution results
```

## FASE 3: Validation and Monitoring

### Heartbeat Verification

**File:** `orchestrator/core/agent_heartbeat.py`

Monitor agent health with `verify_heartbeats()`:

```python
from orchestrator.core.agent_heartbeat import verify_heartbeats

# Check all agents
result = verify_heartbeats(max_age_seconds=120)

print(f"Total agents: {result['total_agents']}")
print(f"Healthy: {result['healthy']['count']}")
print(f"Stale: {result['stale']['count']}")
print(f"Error: {result['error']['count']}")
print(f"Overall: {result['overall_status']}")
```

**Output structure:**
```json
{
  "timestamp": "2025-01-02T12:00:00",
  "total_agents": 100,
  "healthy": {
    "count": 95,
    "agents": [...]
  },
  "stale": {
    "count": 3,
    "agents": [...]
  },
  "error": {
    "count": 2,
    "agents": [...]
  },
  "overall_status": "healthy"
}
```

### Health Alerting

Send alerts for agents exceeding error thresholds:

```python
from orchestrator.core.agent_heartbeat import send_health_alerts

# Alert on agents with 5+ errors
await send_health_alerts(threshold_error_count=5)
```

**Extension points:**
- Email alerts
- Slack notifications
- PagerDuty incidents
- Sentry events

### Integration with Cronjobs

Add to crontab for periodic monitoring:

```bash
# Check agent heartbeats every 5 minutes
*/5 * * * * cd /path/to/orchestrator && python -c "from orchestrator.core.agent_heartbeat import verify_heartbeats; verify_heartbeats()"
```

### CLI Usage

Create a monitoring script:

```python
#!/usr/bin/env python3
"""Agent health monitoring CLI"""

import asyncio
from orchestrator.core.agent_heartbeat import verify_heartbeats, send_health_alerts

def main():
    print("Checking agent heartbeats...")
    result = verify_heartbeats()
    
    if result['overall_status'] != 'healthy':
        print(f"⚠️  System status: {result['overall_status']}")
        
        if result['stale']['count'] > 0:
            print(f"   {result['stale']['count']} stale agents")
        
        if result['error']['count'] > 0:
            print(f"   {result['error']['count']} agents in error state")
            asyncio.run(send_health_alerts())
    else:
        print("✅ All agents healthy")

if __name__ == '__main__':
    main()
```

## Testing

### Run Test Suite

```bash
# Run all FASE tests
pytest tests/test_fase_implementation.py -v

# Run specific test class
pytest tests/test_fase_implementation.py::TestFase1APIRouting -v

# Run with coverage
pytest tests/test_fase_implementation.py --cov=app --cov=orchestrator
```

### Manual Testing

#### Test API Routing
```bash
# Health endpoint
curl http://localhost:10000/healthz
# Should return JSON with status

# API 404
curl http://localhost:10000/api/nonexistent
# Should return JSON error (not HTML)
```

#### Test Authentication
```bash
# Without auth (should fail)
curl -X POST http://localhost:10000/api/agents/test/execute

# With auth (should succeed)
curl -X POST \
     -H "Authorization: Bearer your-api-key" \
     http://localhost:10000/api/agents/test/execute
```

#### Test Agent Registration
```python
import asyncio
from orchestrator.core.agent_registry import get_agent_registry, register_autogen_agents

async def test():
    registry = get_agent_registry()
    result = await register_autogen_agents(registry, count=10)
    print(f"Registered {result['registered']} agents")

asyncio.run(test())
```

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                     Flask Application                        │
│  ┌────────────────────────────────────────────────────────┐ │
│  │              Error Handler (404)                       │ │
│  │  • Returns JSON for /api/* routes                     │ │
│  │  • Returns JSON for /health* routes                   │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │           RoyalGPT API Routes (/api/*)                │ │
│  │  • System capabilities                                │ │
│  │  • Agent status                                       │ │
│  │  • Agent execution (protected)                        │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ uses
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              Authentication Layer                            │
│  ┌────────────────────────────────────────────────────────┐ │
│  │   is_royalgpt_authorized()                            │ │
│  │   • Validates API keys                                │ │
│  │   • Supports Bearer and plain tokens                  │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ protects
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              Agent Orchestration System                      │
│  ┌────────────────────────────────────────────────────────┐ │
│  │          Agent Registry                               │ │
│  │  • 100+ agent support                                 │ │
│  │  • Dynamic agent generation                           │ │
│  │  • Capability-based routing                           │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │     Background Orchestrator Agent                     │ │
│  │  • Continuous execution loop                          │ │
│  │  • Priority-based scheduling                          │ │
│  │  • Concurrency control                                │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │          Heartbeat Monitor                            │ │
│  │  • Agent health verification                          │ │
│  │  • Stale detection                                    │ │
│  │  • Error alerting                                     │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## Production Deployment Checklist

- [ ] Set `API_KEY_ROYALGPT` to a secure token (minimum 32 characters)
- [ ] Set `ENABLE_ROYALGPT_ORCHESTRATION=true`
- [ ] Configure `AUTHORIZED_AGENTS_SCOPE` (comma-separated or "*")
- [ ] Adjust `ORCHESTRATOR_INTERVAL_SECONDS` based on load
- [ ] Set up monitoring for health endpoints
- [ ] Configure alerting system (email, Slack, PagerDuty)
- [ ] Set up periodic heartbeat checks (cronjob or systemd timer)
- [ ] Enable Sentry for error tracking (`SENTRY_DSN`)
- [ ] Review and test all protected endpoints
- [ ] Load test with expected agent count (100+)

## Troubleshooting

### API Returns HTML Instead of JSON

**Symptoms:** API endpoint returns HTML page instead of JSON
**Solution:** Check that route starts with `/api/` and Flask is running

### Authentication Fails

**Symptoms:** 401 Unauthorized on protected endpoints
**Solution:** 
- Verify `API_KEY_ROYALGPT` is set correctly
- Check Authorization header format: `Bearer <token>`
- Ensure token matches configured API key

### Agents Not Executing

**Symptoms:** Background orchestrator not executing agents
**Solution:**
- Verify `ENABLE_ROYALGPT_ORCHESTRATION=true`
- Check agent status with `/api/agents/status`
- Review orchestrator logs for errors
- Verify agents are registered in registry

### Stale Heartbeats

**Symptoms:** Many agents showing stale heartbeats
**Solution:**
- Check agent health individually
- Restart agents with errors
- Verify orchestrator is running
- Check system resources (CPU, memory)

## References

- [Problem Statement](../royalgpt-command-api.yaml) - Original requirements
- [Agent Registry](../orchestrator/core/agent_registry.py) - Agent management
- [Authentication](../core/security/auth.py) - Token-based auth
- [Error Handler](../app/routes/errors.py) - 404 handling
- [Test Suite](../tests/test_fase_implementation.py) - Implementation tests

## Support

For issues or questions:
1. Check test suite for examples
2. Review logs in Flask console
3. Verify environment variables
4. Test with curl/httpie before implementing clients
