name: 'ðŸ—ï¸ Complete CI Pipeline - Royal Equips Empire'

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9.9.0'

jobs:
  lint-and-typecheck:
    name: 'ðŸ” Lint & Type Check'
    runs-on: ubuntu-latest
    
    steps:
      - name: 'ðŸ“¥ Checkout Code'
        uses: actions/checkout@v4
        
      - name: 'ðŸ”§ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: 'ðŸ“¦ Setup pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: 'ðŸ—ï¸ Install Dependencies'
        run: pnpm install --frozen-lockfile --ignore-scripts
        
      - name: 'ðŸ” Run ESLint'
        run: pnpm lint
        
      - name: 'ðŸ“˜ Type Check'
        run: pnpm typecheck

  build-and-test:
    name: 'ðŸ”¨ Build & Test'
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    
    steps:
      - name: 'ðŸ“¥ Checkout Code'
        uses: actions/checkout@v4
        
      - name: 'ðŸ”§ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: 'ðŸ“¦ Setup pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: 'ðŸ—ï¸ Install Dependencies'
        run: pnpm install --frozen-lockfile --ignore-scripts
        
      - name: 'ðŸ”¨ Build All Packages'
        run: pnpm build
        
      - name: 'ðŸ§ª Run Tests'
        run: pnpm test
        
      - name: 'ðŸ“Š Upload Build Artifacts'
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            apps/*/dist/
            packages/*/dist/
          retention-days: 7

  agent-integration-test:
    name: 'ðŸ¤– Agent Integration Tests'
    runs-on: ubuntu-latest
    needs: build-and-test
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
          
    steps:
      - name: 'ðŸ“¥ Checkout Code'
        uses: actions/checkout@v4
        
      - name: 'ðŸ”§ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: 'ðŸ“¦ Setup pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: 'ðŸ—ï¸ Install Dependencies'
        run: pnpm install --frozen-lockfile --ignore-scripts
        
      - name: 'ðŸ”¨ Build Packages'
        run: pnpm build
        
      - name: 'ðŸš€ Start Orchestrator API'
        run: |
          pnpm dev:api &
          sleep 10
          
      - name: 'ðŸ§ª Test API Health'
        run: |
          curl -f http://localhost:10000/healthz
          curl -f http://localhost:10000/readyz
          curl -f http://localhost:10000/metrics
          
      - name: 'ðŸ¤– Test Agent Execution'
        run: |
          # Test basic agent endpoints
          curl -f http://localhost:10000/api/agents
          
  empire-readiness-check:
    name: 'ðŸ‘‘ Empire Readiness Assessment'
    runs-on: ubuntu-latest
    needs: [build-and-test, agent-integration-test]
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    
    steps:
      - name: 'ðŸ“¥ Checkout Code'
        uses: actions/checkout@v4
        
      - name: 'ðŸ”§ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: 'ðŸ“¦ Setup pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: 'ðŸ—ï¸ Install Dependencies'
        run: pnpm install --frozen-lockfile --ignore-scripts
        
      - name: 'ðŸ”¨ Build All'
        run: pnpm build
        
      - name: 'ðŸš€ Start Complete System'
        run: |
          # Start API server
          pnpm dev:api &
          API_PID=$!
          sleep 10
          
          # Start Command Center UI  
          pnpm --filter @royal-equips/command-center-ui dev &
          UI_PID=$!
          sleep 15
          
          # Health checks
          echo "ðŸ” Testing API Health..."
          curl -f http://localhost:10000/healthz || exit 1
          curl -f http://localhost:10000/readyz || exit 1
          curl -f http://localhost:10000/metrics || exit 1
          
          echo "ðŸ” Testing Command Center..."
          curl -f http://localhost:3000 || exit 1
          
          echo "âœ… All systems operational!"
          
          # Cleanup
          kill $API_PID $UI_PID || true
          
      - name: 'ðŸ“‹ Empire Status Report'
        run: |
          echo "## ðŸ‘‘ Royal Equips Empire Status Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ **Mission**: Bootstrap Autonomous Empire Orchestrator v1" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Systems Online:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ Orchestrator API (Port 10000)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ® Holographic Command Center (Port 3000)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¤– Agent Execution Framework" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ Plan/DryRun/Apply Pattern" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ Health Monitoring" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ¤– Agents Deployed:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” ProductResearchAgent (Tier 1)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’° PricingAgent (Framework Ready)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ InventoryAgent (Framework Ready)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›’ OrdersAgent (Framework Ready)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‘ï¸ ObserverAgent (Framework Ready)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ—ï¸ Infrastructure:" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ Fastify API with Swagger Docs" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ® React + Three.js Holographic UI" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— Shopify & Supabase Connectors" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’» Interactive Command Console" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Real-time KPI Visualization" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ðŸŸ¢ Empire Foundation Complete - Ready for Agent Deployment!" >> $GITHUB_STEP_SUMMARY

  notify-empire-status:
    name: 'ðŸ“¢ Empire Status Notification'
    runs-on: ubuntu-latest
    needs: [empire-readiness-check]
    if: always() && github.ref == 'refs/heads/master'
    
    steps:
      - name: 'ðŸ“Š Determine Status'
        id: status
        run: |
          if [[ "${{ needs.empire-readiness-check.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=ðŸŽ‰ Empire systems fully operational! All agents ready for autonomous deployment." >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=âš ï¸ Empire systems require attention. Check the build for details." >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          fi
          
      - name: 'ðŸ‘‘ Empire Status Update'
        run: |
          echo "## ðŸ‘‘ ROYAL EQUIPS EMPIRE STATUS"
          echo "**Build**: ${{ github.run_number }}"
          echo "**Commit**: ${{ github.sha }}"
          echo "**Status**: ${{ steps.status.outputs.message }}"
          echo ""
          echo "**Next Phase**: Deploy Tier 1 autonomous agents for 24/7 operations"