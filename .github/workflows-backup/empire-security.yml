name: 'ðŸ›¡ï¸ Empire Security - Advanced Threat Detection'

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  schedule:
    # Daily security scan at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9.9.0'

jobs:
  security-analysis:
    name: 'ðŸ” Advanced Security Analysis'
    runs-on: ubuntu-latest
    
    permissions:
      actions: read
      contents: read
      security-events: write
      
    steps:
      - name: 'ðŸ“¥ Checkout Empire Code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: 'ðŸ”§ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: 'ðŸ“¦ Setup pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

  codeql-analysis:
    name: 'ðŸ§¬ CodeQL Deep Analysis'
    runs-on: ubuntu-latest
    
    permissions:
      actions: read
      contents: read
      security-events: write
      
    strategy:
      fail-fast: false
      matrix:
        language: ['javascript', 'typescript']
        
    steps:
      - name: 'ðŸ“¥ Checkout Repository'
        uses: actions/checkout@v4
        
      - name: 'ðŸ§¬ Initialize CodeQL'
        uses: github/codeql-action@v3
        with:
          languages: ${{ matrix.language }}
          config-file: ./.github/codeql/codeql-config.yml
          
      - name: 'ðŸ”§ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: 'ðŸ“¦ Setup pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: 'ðŸ—ï¸ Build for Analysis'
        run: |
          pnpm install --frozen-lockfile --ignore-scripts
          pnpm build
          
      - name: 'ðŸ§¬ Perform CodeQL Analysis'
        uses: github/codeql-action@v3
        with:
          category: "/language:${{matrix.language}}"

  gitleaks-scan:
    name: 'ðŸ” Secret Scanning with GitLeaks'
    runs-on: ubuntu-latest
    
    steps:
      - name: 'ðŸ“¥ Checkout Code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: 'ðŸ” Run GitLeaks Secret Scan'
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  trivy-security-scan:
    name: 'ðŸ”¬ Trivy Vulnerability Scan'
    runs-on: ubuntu-latest
    
    steps:
      - name: 'ðŸ“¥ Checkout Repository'
        uses: actions/checkout@v4
        
      - name: 'ðŸ”¬ Run Trivy Vulnerability Scanner'
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          
      - name: 'ðŸ“Š Upload Trivy Results to Security Tab'
        uses: github/codeql-action@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  dependency-review:
    name: 'ðŸ“¦ Dependency Security Review'
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: 'ðŸ“¥ Checkout Code'
        uses: actions/checkout@v4
        
      - name: 'ðŸ“¦ Dependency Review'
        uses: actions/dependency-review-action@4081bf99e2866ebe428fc0477b69eb4fcda7220a  # actions/dependency-review-action@v4
        with:
          fail-on-severity: critical
          fail-on-score: 0.7
          
  npm-audit:
    name: 'ðŸ” NPM Security Audit'
    runs-on: ubuntu-latest
    
    steps:
      - name: 'ðŸ“¥ Checkout Code'
        uses: actions/checkout@v4
        
      - name: 'ðŸ”§ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: 'ðŸ“¦ Setup pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: 'ðŸ—ï¸ Install Dependencies'
        run: pnpm install --frozen-lockfile --ignore-scripts
        
      - name: 'ðŸ” Run Security Audit'
        run: |
          echo "ðŸ” Running comprehensive security audit..."
          
          # Run pnpm audit
          pnpm audit --audit-level=high || AUDIT_FAILED=true
          
          # Check for known vulnerabilities
          echo "ðŸ“Š Audit Summary:"
          pnpm audit --json > audit-results.json || true
          
          if [[ "$AUDIT_FAILED" == "true" ]]; then
            echo "âš ï¸ Security vulnerabilities detected!"
            echo "ðŸ“‹ Review audit-results.json for details"
            
            # In production, could auto-create issues for critical vulnerabilities
            exit 1
          else
            echo "âœ… No high-severity vulnerabilities detected"
          fi

  empire-security-policy-check:
    name: 'âš–ï¸ Empire Security Policy Enforcement'
    runs-on: ubuntu-latest
    
    steps:
      - name: 'ðŸ“¥ Checkout Code'
        uses: actions/checkout@v4
        
      - name: 'âš–ï¸ Enforce Security Policies'
        run: |
          echo "âš–ï¸ Checking Royal Equips Empire Security Policies..."
          
          POLICY_VIOLATIONS=0
          
          # Check 1: Ensure no hardcoded secrets
          echo "ðŸ” Checking for hardcoded secrets..."
          if grep -r "api[_-]key\|password\|secret" --include="*.ts" --include="*.js" apps/ packages/ || true; then
            echo "âŒ Potential hardcoded secrets detected"
            POLICY_VIOLATIONS=$((POLICY_VIOLATIONS + 1))
          fi
          
          # Check 2: Ensure proper error handling
          echo "ðŸ›¡ï¸ Checking error handling patterns..."
          if ! grep -r "try.*catch" --include="*.ts" apps/*/src/ packages/*/src/ > /dev/null; then
            echo "âš ï¸ Limited error handling detected - consider adding more try/catch blocks"
          fi
          
          # Check 3: Validate environment variable usage
          echo "ðŸŒ Checking environment variable security..."
          if grep -r "process\.env\." --include="*.ts" --include="*.js" apps/ packages/ | grep -v "NODE_ENV" | head -5; then
            echo "â„¹ï¸ Environment variables in use - ensure they're properly secured"
          fi
          
          # Check 4: Ensure TypeScript strict mode
          echo "ðŸ“˜ Checking TypeScript configuration..."
          if ! grep -r '"strict": true' tsconfig*.json; then
            echo "âš ï¸ TypeScript strict mode not enabled in all configs"
            POLICY_VIOLATIONS=$((POLICY_VIOLATIONS + 1))
          fi
          
          # Check 5: Validate package.json security
          echo "ðŸ“¦ Checking package.json security..."
          if grep -r "\"scripts\"" package.json | grep -E "(rm -rf|sudo|curl.*sh)"; then
            echo "âŒ Potentially dangerous scripts detected"
            POLICY_VIOLATIONS=$((POLICY_VIOLATIONS + 1))
          fi
          
          # Final policy verdict
          echo ""
          echo "ðŸ“Š Security Policy Check Results:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [[ $POLICY_VIOLATIONS -eq 0 ]]; then
            echo "âœ… All security policies compliant"
            echo "ðŸ° Empire security standards maintained"
          else
            echo "âŒ $POLICY_VIOLATIONS policy violations detected"
            echo "ðŸš¨ Review required before deployment"
            exit 1
          fi

  security-summary:
    name: 'ðŸ“‹ Security Analysis Summary'
    runs-on: ubuntu-latest
    needs: [codeql-analysis, gitleaks-scan, trivy-security-scan, npm-audit, empire-security-policy-check]
    if: always()
    
    steps:
      - name: 'ðŸ“Š Generate Security Summary'
        run: |
          echo "## ðŸ›¡ï¸ Royal Equips Empire - Security Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ• Scan Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ” Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“Š Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check job results
          CODEQL_STATUS="${{ needs.codeql-analysis.result }}"
          GITLEAKS_STATUS="${{ needs.gitleaks-scan.result }}"
          TRIVY_STATUS="${{ needs.trivy-security-scan.result }}"
          AUDIT_STATUS="${{ needs.npm-audit.result }}"
          POLICY_STATUS="${{ needs.empire-security-policy-check.result }}"
          
          echo "### ðŸ” Security Scan Results:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # CodeQL Analysis
          if [[ "$CODEQL_STATUS" == "success" ]]; then
            echo "- âœ… **CodeQL Analysis**: No critical vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **CodeQL Analysis**: Issues detected - check Security tab" >> $GITHUB_STEP_SUMMARY
          fi
          
          # GitLeaks
          if [[ "$GITLEAKS_STATUS" == "success" ]]; then
            echo "- âœ… **Secret Scanning**: No leaked secrets found" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Secret Scanning**: Potential secrets detected" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Trivy
          if [[ "$TRIVY_STATUS" == "success" ]]; then
            echo "- âœ… **Vulnerability Scan**: No high-severity issues" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Vulnerability Scan**: High-severity vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          fi
          
          # NPM Audit
          if [[ "$AUDIT_STATUS" == "success" ]]; then
            echo "- âœ… **Dependency Audit**: All packages secure" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Dependency Audit**: Vulnerable dependencies detected" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Policy Check
          if [[ "$POLICY_STATUS" == "success" ]]; then
            echo "- âœ… **Security Policies**: All policies compliant" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Security Policies**: Policy violations detected" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [[ "$CODEQL_STATUS" == "success" && "$GITLEAKS_STATUS" == "success" && "$TRIVY_STATUS" == "success" && "$AUDIT_STATUS" == "success" && "$POLICY_STATUS" == "success" ]]; then
            echo "### ðŸŽ‰ Overall Status: **SECURE** ðŸ°" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… The Royal Equips Empire meets all security standards" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ Safe for autonomous operations" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Overall Status: **REQUIRES ATTENTION** ðŸš¨" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ Security issues detected - review required" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”’ Address issues before deployment" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*ðŸ¤– Automated security analysis by Royal Equips Empire*" >> $GITHUB_STEP_SUMMARY